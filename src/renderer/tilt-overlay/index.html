<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">
  <title>Tilt Overlay</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: transparent;
      color: #c8c8c8;
      overflow: hidden;
      user-select: none;
      pointer-events: none;
    }

    .panel {
      background: rgba(10, 10, 20, 0.94);
      border: 1px solid #2a2a4a;
      border-radius: 8px;
      padding: 14px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      pointer-events: auto;
    }

    .panel::-webkit-scrollbar { width: 4px; }
    .panel::-webkit-scrollbar-track { background: transparent; }
    .panel::-webkit-scrollbar-thumb { background: rgba(200, 155, 60, 0.3); border-radius: 2px; }

    /* ── Header ── */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(200, 155, 60, 0.2);
    }

    .header-title {
      font-size: 13px;
      font-weight: 700;
      color: #c89b3c;
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }

    .session-badge {
      font-size: 10px;
      color: #888;
    }

    /* ── Score gauge ── */
    .score-section {
      text-align: center;
      padding: 8px 0;
    }

    .score-ring {
      position: relative;
      width: 90px;
      height: 90px;
      margin: 0 auto 6px;
    }

    .score-ring svg {
      transform: rotate(-90deg);
    }

    .score-ring-bg { stroke: rgba(255, 255, 255, 0.06); }
    .score-ring-fill { transition: stroke-dashoffset 0.8s ease, stroke 0.4s ease; }

    .score-number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px;
      font-weight: 700;
    }

    .score-number.cool { color: #55c06a; }
    .score-number.warming { color: #e0c050; }
    .score-number.tilted { color: #e07830; }
    .score-number.danger_zone { color: #e04040; }

    .tilt-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .tilt-label.cool { color: #55c06a; }
    .tilt-label.warming { color: #e0c050; }
    .tilt-label.tilted { color: #e07830; }
    .tilt-label.danger_zone { color: #e04040; }

    /* ── Session stats ── */
    .session-stats {
      display: flex;
      justify-content: space-around;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 700;
      color: #ddd;
    }

    .stat-label {
      font-size: 9px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ── Recommendation ── */
    .recommendation {
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .rec-headline {
      font-size: 15px;
      font-weight: 700;
      color: #f0e6d2;
      margin-bottom: 6px;
    }

    .rec-message {
      font-size: 11px;
      color: #aaa;
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .rec-analysis {
      font-size: 10px;
      color: #777;
      font-style: italic;
      margin-bottom: 10px;
      padding: 6px 8px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 4px;
      line-height: 1.4;
    }

    /* ── Exercise cards ── */
    .activity-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .activity-type {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #c89b3c;
    }

    .activity-duration {
      font-size: 10px;
      color: #888;
    }

    .exercise-card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 6px;
      padding: 8px 10px;
      margin-bottom: 4px;
    }

    .exercise-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .exercise-name {
      font-size: 12px;
      font-weight: 600;
      color: #ddd;
    }

    .exercise-reps {
      font-size: 11px;
      color: #c89b3c;
      font-weight: 500;
    }

    .exercise-desc {
      font-size: 10px;
      color: #777;
      margin-top: 3px;
      line-height: 1.3;
    }

    /* ── Waiting state ── */
    .waiting {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #555;
      font-size: 12px;
      text-align: center;
      gap: 8px;
    }

    .waiting .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid rgba(200, 155, 60, 0.2);
      border-top-color: #c89b3c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="panel">
    <!-- Header -->
    <div class="header">
      <div class="header-title">Tilt Guard</div>
      <div class="session-badge" id="session-badge"></div>
    </div>

    <!-- Score gauge -->
    <div class="score-section hidden" id="score-section">
      <div class="score-ring">
        <svg width="90" height="90" viewBox="0 0 90 90">
          <circle class="score-ring-bg" cx="45" cy="45" r="38" fill="none" stroke-width="6" />
          <circle class="score-ring-fill" id="score-ring" cx="45" cy="45" r="38" fill="none"
            stroke-width="6" stroke-linecap="round"
            stroke-dasharray="238.76" stroke-dashoffset="238.76" />
        </svg>
        <div class="score-number" id="score-number">--</div>
      </div>
      <div class="tilt-label" id="tilt-label"></div>
    </div>

    <!-- Session stats -->
    <div class="session-stats hidden" id="session-stats">
      <div class="stat">
        <div class="stat-value" id="stat-wins">0</div>
        <div class="stat-label">Wins</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-losses">0</div>
        <div class="stat-label">Losses</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-games">0</div>
        <div class="stat-label">Games</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-kda">--</div>
        <div class="stat-label">KDA Trend</div>
      </div>
    </div>

    <!-- Recommendation content -->
    <div class="recommendation hidden" id="recommendation"></div>

    <!-- Waiting state -->
    <div class="waiting" id="waiting">
      <div class="spinner"></div>
      <div>Analyzing your session...</div>
      <div style="font-size: 10px; color: #444;">Post-game report will appear here</div>
    </div>
  </div>

  <script>
    const CIRCUMFERENCE = 2 * Math.PI * 38; // ~238.76

    const $scoreSection = document.getElementById("score-section");
    const $scoreRing = document.getElementById("score-ring");
    const $scoreNumber = document.getElementById("score-number");
    const $tiltLabel = document.getElementById("tilt-label");
    const $sessionStats = document.getElementById("session-stats");
    const $sessionBadge = document.getElementById("session-badge");
    const $recommendation = document.getElementById("recommendation");
    const $waiting = document.getElementById("waiting");

    const levelLabels = {
      cool: "Cool",
      warming: "Warming Up",
      tilted: "Tilted",
      danger_zone: "Danger Zone",
    };

    const levelColors = {
      cool: "#55c06a",
      warming: "#e0c050",
      tilted: "#e07830",
      danger_zone: "#e04040",
    };

    function formatActivityType(type) {
      return (type || "routine").replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
    }

    function updateScore(score, level) {
      $scoreSection.classList.remove("hidden");
      $scoreNumber.textContent = score;
      $scoreNumber.className = `score-number ${level}`;

      // Animate ring
      const offset = CIRCUMFERENCE - (score / 100) * CIRCUMFERENCE;
      $scoreRing.style.strokeDashoffset = offset;
      $scoreRing.style.stroke = levelColors[level] || levelColors.cool;

      $tiltLabel.textContent = levelLabels[level] || level;
      $tiltLabel.className = `tilt-label ${level}`;
    }

    function updateSessionStats(data) {
      $sessionStats.classList.remove("hidden");
      document.getElementById("stat-wins").textContent = data.wins || 0;
      document.getElementById("stat-losses").textContent = data.losses || 0;
      document.getElementById("stat-games").textContent = data.games_played || 0;

      const trend = data.metrics?.kda_trend || "--";
      const trendEl = document.getElementById("stat-kda");
      trendEl.textContent = trend === "improving" ? "Up" : trend === "declining" ? "Down" : "Stable";
      trendEl.style.color = trend === "improving" ? "#55c06a" : trend === "declining" ? "#e04040" : "#888";

      $sessionBadge.textContent = `${data.wins || 0}W ${data.losses || 0}L`;
    }

    function renderRecommendation(data) {
      $waiting.classList.add("hidden");
      $recommendation.classList.remove("hidden");

      let html = "";

      // Headline + message
      html += `<div class="rec-headline">${data.headline || ""}</div>`;
      html += `<div class="rec-message">${data.message || ""}</div>`;

      // Session analysis
      if (data.session_analysis) {
        html += `<div class="rec-analysis">${data.session_analysis}</div>`;
      }

      // Activity with exercises
      if (data.activity && data.activity.exercises && data.activity.exercises.length > 0) {
        html += `<div class="activity-header">
          <span class="activity-type">${formatActivityType(data.activity.type)}</span>
          <span class="activity-duration">${data.activity.duration_minutes || "?"} min</span>
        </div>`;

        for (const ex of data.activity.exercises) {
          html += `<div class="exercise-card">
            <div class="exercise-top">
              <span class="exercise-name">${ex.name}</span>
              <span class="exercise-reps">${ex.reps_or_duration}</span>
            </div>
            ${ex.description ? `<div class="exercise-desc">${ex.description}</div>` : ""}
          </div>`;
        }
      }

      $recommendation.innerHTML = html;
    }

    // ── IPC listeners ──
    if (window.riftApi) {
      window.riftApi.on("tilt:score-update", (data) => {
        $waiting.classList.add("hidden");
        updateScore(data.score, data.level);
      });

      window.riftApi.on("tilt:recommendation", (data) => {
        renderRecommendation(data);
      });

      window.riftApi.on("tilt:session-summary", (data) => {
        updateSessionStats(data);
      });

      // Reset on phase change
      window.riftApi.on("orchestrator:phase-changed", (phase) => {
        if (phase === "IDLE" || phase === "LOBBY" || phase === "CHAMP_SELECT") {
          // Keep showing the recommendation until next game
        }
        if (phase === "IN_GAME") {
          // Hide during gameplay
          $recommendation.classList.add("hidden");
          $recommendation.innerHTML = "";
        }
      });
    }
  </script>
  <div style="position: fixed; bottom: 0; left: 0; right: 0; font-size: 7px; color: #444; text-align: center; padding: 3px 6px; line-height: 1.3;">Rift Architect isn't endorsed by Riot Games and doesn't reflect the views or opinions of Riot Games or anyone officially involved in producing or managing Riot Games properties.</div>
</body>
</html>
